"use strict";var message_input=document.getElementById("messages-input"),dummyAudio=document.getElementById("dummyAudio");function initSocketListeners(){socket.on("usersInGroup",function(e){for(var a in console.log("usersInGroup:"),e.users)console.log(a),addUser(a,e.users[a].name,e.users[a].prof_pic)}),socket.on("newUser",function(e){console.log("newUser: "+e),addUser(e.id,e.name,e.prof_pic),addMessage(e.id,"Joined the group",!0)}),socket.on("userLeft",function(e){console.log("userLeft: "+e),addMessage(e,"Left the group",!0),removeUser(e)}),socket.on("messageBanned",function(e){alert('The message you sent is banned for containing the word "'.concat(e,'"'))}),socket.on("newMessage",function(e){addMessage(e.id,e.message,!1)}),socket.on("typing",function(e){userTyping(e)}),socket.on("changeSong",function(e){spotifyPlay(e.uri,e.context,null,null),setTimeout(function(){(e.paused?playbackPause:playbackResume)(),addSongChangeMessage(e.id)},500)}),socket.on("pause",function(e){paused||(playbackPause(),addMessage(e,"Paused playback",!0))}),socket.on("resume",function(e){paused&&(playbackResume(),addMessage(e,"Resumed playback",!0))}),socket.on("whereAreWe",function(a){spotifyPlayer.getCurrentState().then(function(e){e?(currentTrack=e.track_window.current_track.uri,socket.emit("weAreHere",{uri:e.track_window.current_track.uri,context:e.context.uri,position:e.position,paused:e.paused,socketId:a})):console.error("No music playing.")})}),socket.on("weAreHere",function(e){currentTrack=e.uri,spotifyPlay(e.uri,e.context,e.position,null),setTimeout(function(){updatePlayer(),(e.paused?playbackPause:playbackResume)()},1500),setTimeout(function(){e.queue.forEach(function(e){addToSpotifyQueue(e)})},5e3)}),socket.on("addToQueue",function(e){addToSpotifyQueue(e.uri),addMessage(e.id,"Added "+e.name+" by "+e.artist+" to the queue",!0)})}$(document).ready(function(){});var dummySearch=document.getElementById("dummy-search"),actualSearch=document.getElementById("search-input-input"),searchQuery="",screenBlock=$(".screen-block"),searchOverlay=$(".search-overlay");function fadeInSearch(){screenBlock.css("display","block"),screenBlock.animate({opacity:1},250),searchOverlay.css("display","grid"),searchOverlay.animate({opacity:1},250)}function fadeOutSearch(){screenBlock.animate({opacity:0},250),searchOverlay.animate({opacity:0},250),setTimeout(function(){screenBlock.css("display","none"),searchOverlay.css("display","none")},250)}function addSongChangeMessage(a){console.log("ADD SONG CHANGE MESSAGE"),spotifyPlayer.getCurrentState().then(function(e){e?addMessage(a,"Now playing "+e.track_window.current_track.name,!0):console.error("No music playing.")})}function msToMinutesSeconds(e){var a=e/1e3,t=Math.floor(e/60),o=Math.floor(a-t);return t.toString()+":"+o.toString().padStart(2,"0")}function searchSpotify(e){$.ajax({url:"https://api.spotify.com/v1/search?type=album,artist,track,playlist&limit=8&q="+e,type:"GET",dataType:"json",headers:{Authorization:"Bearer "+accessToken},success:function(e){searchSpotifyResponse(e)},error:function(e){alert("An error occured while searching."),console.log(e)}})}function searchSpotifyResponse(e){console.log(e),addSongsResults(e.tracks),addArtistResults(e.artists),addAlbumsResults(e.albums),addPlaylistsResults(e.playlists),$(".search-item-image-container").hover(function(){$(".search-item-fan[data-id='"+$(this).data("id")+"']").stop(!0,!0),$(".search-item-fan[data-id='"+$(this).data("id")+"']").animate({width:"18em",paddingLeft:"4em",paddingRight:"1em"},150),$(".search-item-text-container[data-id='"+$(this).data("id")+"']").stop(!0,!0),$(".search-item-text-container[data-id='"+$(this).data("id")+"']").animate({marginLeft:"-4em",opacity:0},150)},function(){$(".search-item-fan[data-id='"+$(this).data("id")+"']").stop(!0,!0),$(".search-item-fan[data-id='"+$(this).data("id")+"']").animate({width:"0",paddingLeft:"0",paddingRight:"0"},150),$(".search-item-text-container[data-id='"+$(this).data("id")+"']").stop(!0,!0),$(".search-item-text-container[data-id='"+$(this).data("id")+"']").animate({marginLeft:"1.6vw",opacity:1},150)}),$(".search-item-play").click(function(){socket.emit("makeMeHost"),"song"==$(this).data("type")?spotifyPlay("spotify:track:"+$(this).data("id"),"spotify:album:"+$(this).data("extra"),null,!0):"playlist"==$(this).data("type")?spotifyPlayPlaylistAlbum("spotify:playlist:"+$(this).data("id"),!0):"artist"==$(this).data("type")?spotifyPlayArtist("spotify:artist:"+$(this).data("id")):"album"==$(this).data("type")&&spotifyPlayPlaylistAlbum("spotify:album:"+$(this).data("id"),!0),setTimeout(function(){changedSong(),updatePlayer(),addSongChangeMessage(user_id)},500),dummyAudio.play()}),$(".search-item-queue").click(function(){var e="spotify:track:"+$(this).data("id"),a=$(".search-item-name[data-id='"+$(this).data("id")+"']").html(),t=$(".search-item-artist[data-id='"+$(this).data("id")+"']").html(),o=$(".search-item-image[data-id='"+$(this).data("id")+"']").attr("src");addToSpotifyQueue(e,!0),socket.emit("addToQueue",{uri:e,name:a,artist:t,image:o}),addMessage(user_id,"Added "+a+" by "+t+" to the queue.",!0)}),$(".search-item-fan").css("width","0"),$(".search-item-fan").css("padding-left","0"),$(".search-item-fan").css("padding-right","0")}function spotifyPlay(e){var a,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,s=3<arguments.length&&void 0!==arguments[3]&&arguments[3];console.log("SPOTIFY PLAY:"),console.log("TRACK: "+e),console.log("CONTEXT: "+t),null!=t?("artist"==t.substring(8,14)&&(a=JSON.stringify({context_uri:t})),a=null!=o?JSON.stringify({context_uri:t,offset:{uri:e},position_ms:o}):JSON.stringify({context_uri:t,offset:{uri:e}}),$.ajax({url:"https://api.spotify.com/v1/me/player/play?device_id="+deviceId,data:a,type:"PUT",headers:{Authorization:"Bearer "+accessToken},success:function(){console.log("PLAY REQUEST SUCCESSFUL"),s&&makePopup("Playing song")},error:function(e){console.error("PLAY RESULT FAILED:"),console.error(e),s&&makePopup("Could not play song",!0)}})):(null!=o?JSON.stringify({uris:[e],position_ms:o}):JSON.stringify({uris:[e]}),$.ajax({url:"https://api.spotify.com/v1/me/player/play?device_id="+deviceId,data:void 0,type:"PUT",headers:{Authorization:"Bearer "+accessToken},success:function(){console.log("PLAY REQUEST SUCCESSFUL"),s&&makePopup("Playing song")},error:function(e){console.error("PLAY RESULT FAILED:"),console.error(e),s&&makePopup("Could not play song",!0)}}))}function spotifyPlayPlaylistAlbum(e){var a=1<arguments.length&&void 0!==arguments[1]&&arguments[1];$.ajax({url:"https://api.spotify.com/v1/me/player/play?device_id="+deviceId,data:JSON.stringify({context_uri:e,offset:{position:0}}),type:"PUT",headers:{Authorization:"Bearer "+accessToken},success:function(){console.log("PLAY REQUEST SUCCESSFUL"),a&&makePopup("Playing successfully")},error:function(e){console.error("PLAY RESULT FAILED:"),console.error(e),makePopup("Couldn't play",!0)}})}function addToSpotifyQueue(e){var a=1<arguments.length&&void 0!==arguments[1]&&arguments[1];console.log(e),console.log("addToSpotifyQueue"),console.log("https://api.spotify.com/v1/me/player/queue?uri="+e+"&device_id="+deviceId),console.log("Bearer "+accessToken),$.ajax({url:"https://api.spotify.com/v1/me/player/queue?uri="+e+"&device_id="+deviceId,type:"POST",headers:{Authorization:"Bearer "+accessToken},success:function(e){console.log("ADD TO QUEUE SUCCESSFUL"),console.log(e),a&&makePopup("Added to queue")},error:function(e){console.error("ADD TO QUEUE FAILED:"),console.error(e),a&&makePopup("Could not add to queue",!0)}})}document.getElementById("messages-input").addEventListener("keyup",function(e){13===e.keyCode?(e.preventDefault(),socket.emit("message",message_input.value),message_input.value=""):socket.emit("typing")}),dummySearch.addEventListener("keyup",function(e){13===e.keyCode&&(e.preventDefault(),searchQuery=dummySearch.value,actualSearch.value=searchQuery,fadeInSearch(),setTimeout(function(){dummySearch.value=""},500),searchSpotify(searchQuery))}),actualSearch.addEventListener("keyup",function(e){13===e.keyCode&&(e.preventDefault(),searchSpotify(searchQuery=actualSearch.value))}),screenBlock.click(function(){fadeOutSearch()});var paused=!1;function changedSong(){$("#player-control-pause").css("background-image","url('img/control-pause.svg')"),spotifyPlayer.getCurrentState().then(function(e){e?(console.log("CONTEXT: "+e.context.uri),console.log("URI: "+e.track_window.current_track.uri),currentTrack=e.track_window.current_track.uri,socket.emit("changeSong",{uri:e.track_window.current_track.uri,context:e.context.uri,name:e.track_window.current_track.name,paused:e.paused}),(e.paused?playbackPause:playbackResume)()):console.error("No music playing.")}),console.log("CHANGED SONG CALLED")}$("#player-control-pause").click(function(){(paused=!paused)?(playbackPause(),socket.emit("pause"),addMessage(user_id,"Paused playback",!0)):(playbackResume(),socket.emit("resume"),addMessage(user_id,"Resumed playback",!0))}),$("#player-control-back").click(function(){socket.emit("makeMeHost"),spotifyPlayer.previousTrack(),setTimeout(function(){changedSong(!0),updatePlayer(),addSongChangeMessage(user_id)},250)}),$("#player-control-forward").click(function(){socket.emit("makeMeHost"),spotifyPlayer.nextTrack(),setTimeout(function(){changedSong(!0),updatePlayer(),addSongChangeMessage(user_id)},250)});var playerImg=$("#player-image"),playerName=$("#player-name"),playerArtist=$("#player-artist");function updatePlayer(){spotifyPlayer.getCurrentState().then(function(e){e?(playerImg.attr("src",e.track_window.current_track.album.images[0].url),playerName.html(e.track_window.current_track.name),playerArtist.html(e.track_window.current_track.artists[0].name)):console.error("No music playing.")})}function playbackPause(){spotifyPlayer.pause(),dummyAudio.pause(),$("#player-control-pause").css("background-image","url('img/control-play.svg')"),paused=!0}function playbackResume(){spotifyPlayer.resume(),dummyAudio.play(),$("#player-control-pause").css("background-image","url('img/control-pause.svg')"),paused=!1}function updateMediaSession(){"mediaSession"in navigator&&spotifyPlayer.getCurrentState().then(function(e){var a=[];e.track_window.current_track.album.images.forEach(function(e){a.push({src:e.url,sizes:e.width+"x"+e.height,type:"image/jpeg"})}),navigator.mediaSession.metadata=new MediaMetadata({title:e.track_window.current_track.name,artist:e.track_window.current_track.artists[0].name,album:e.track_window.current_track.album.name,artwork:a})})}"mediaSession"in navigator&&(console.log("ADDING MEDIA HADNLERS"),navigator.mediaSession.setActionHandler("pause",function(){playbackPause(),socket.emit("pause"),addMessage(user_id,"Paused playback",!0),dummyAudio.pause()}),navigator.mediaSession.setActionHandler("play",function(){playbackResume(),socket.emit("resume"),addMessage(user_id,"Resumed playback",!0),dummyAudio.play()}),navigator.mediaSession.setActionHandler("nexttrack",function(){socket.emit("makeMeHost"),spotifyPlayer.nextTrack(),setTimeout(function(){changedSong(!0),updatePlayer(),addSongChangeMessage(user_id)},250)}),navigator.mediaSession.setActionHandler("previoustrack",function(){socket.emit("makeMeHost"),spotifyPlayer.previousTrack(),setTimeout(function(){changedSong(!0),updatePlayer(),addSongChangeMessage(user_id)},250)}));