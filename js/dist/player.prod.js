"use strict";var message_input=document.getElementById("messages-input"),dummyAudio=document.getElementById("dummyAudio"),screenBlock=$(".screen-block"),screenBlockShare=$(".screen-block-share"),searchOverlay=$(".search-overlay"),shareContainer=$("#share-container"),likeBtn=$(".player-share-like"),shareBtn=$(".player-share-share"),playlistBtn=$(".player-share-playlist");function initSocketListeners(){socket.on("usersInGroup",function(e){for(var t in console.log("usersInGroup:"),e.users)console.log(t),addUser(t,e.users[t].name,e.users[t].prof_pic)}),socket.on("newUser",function(e){console.log("newUser: "+e),addUser(e.id,e.name,e.prof_pic),addMessage(e.id,"Joined the group",!0)}),socket.on("userLeft",function(e){console.log("userLeft: "+e),addMessage(e,"Left the group",!0),removeUser(e)}),socket.on("userBanned",function(){window.location.href="logout.php?action=banned"}),socket.on("messageBanned",function(e){alert('The message you sent is banned for containing the word "'.concat(e,'"'))}),socket.on("newMessage",function(e){addMessage(e.id,e.message,!1)}),socket.on("typing",function(e){userTyping(e)}),socket.on("changeSong",function(e){spotifyPlay(e.uri,e.context,null,null),setTimeout(function(){(e.paused?playbackPause:playbackResume)(),addSongChangeMessage(e.id)},500)}),socket.on("pause",function(e){paused||(playbackPause(),addMessage(e,"Paused playback",!0))}),socket.on("resume",function(e){paused&&(playbackResume(),addMessage(e,"Resumed playback",!0))}),socket.on("whereAreWe",function(t){spotifyPlayer.getCurrentState().then(function(e){e?(currentTrack=e.track_window.current_track.uri,socket.emit("weAreHere",{uri:e.track_window.current_track.uri,context:e.context.uri,position:e.position,paused:e.paused,socketId:t})):console.error("No music playing.")})}),socket.on("weAreHere",function(e){currentTrack=e.uri,spotifyPlay(e.uri,e.context,e.position,null),setTimeout(function(){updatePlayer(),(e.paused?playbackPause:playbackResume)()},1500),setTimeout(function(){e.queue.forEach(function(e){addToSpotifyQueue(e)})},5e3),makePopup("All caught up!")}),socket.on("addToQueue",function(e){addToSpotifyQueue(e.uri),addMessage(e.id,"Added "+e.name+" by "+e.artist+" to the queue",!0)})}"join"==urlParams.get("action")&&fadeOutSearch();var dummySearch=document.getElementById("dummy-search"),actualSearch=document.getElementById("search-input-input"),searchQuery="";function fadeInSearch(){screenBlock.css("display","block"),screenBlock.animate({opacity:1},250),searchOverlay.css("display","grid"),searchOverlay.animate({opacity:1},250)}function fadeOutSearch(){screenBlock.animate({opacity:0},250),searchOverlay.animate({opacity:0},250),setTimeout(function(){screenBlock.css("display","none"),searchOverlay.css("display","none")},250)}function fadeInShare(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];screenBlockShare.css("display","block"),screenBlockShare.animate({opacity:1},250),shareContainer.css("display","flex"),shareContainer.animate({opacity:1},250),t?(shareContainer.find(".grid-title").html("Share "+t),$("#twitter").attr("href","https://twitter.com/intent/tweet?url="+e+"&text=Checkout this "+t+" on Spotify:"),$("#email").attr("href","mailto:?subject=Checkout%20this%20"+t+"&body=Hey!%0D%0A%0D%0ACheckout%20this%20"+t+"%20on%20Spotify!%0D%0A"+e),$("#link").html(e),$("#fb").attr("href","https://www.facebook.com/sharer/sharer.php?u="+e)):(shareContainer.find(".grid-title").html("Invite users"),$("#twitter").attr("href","https://twitter.com/intent/tweet?url=https://morahman.me/musictogether/join.php?group_id="+e+"&text=Join my Music Together group:"),$("#email").attr("href","mailto:?subject=Join%20my%20Music%20Together%20group!&body=Hey!Join%20my%20Music%20Together%20group%20session%20here%3Ahttps%3A%2F%2Fmorahman.me%2Fmusictogether%2Fjoin.php%3Fgroup_id%3D"+e),$("#link").html("https://morahman.me/musictogether/join.php?group_id="+e),$("#fb").attr("href","https://www.facebook.com/sharer/sharer.php?u=https://morahman.me/musictogether/join.php?group_id="+e))}function fadeOutShare(){screenBlockShare.animate({opacity:0},250),shareContainer.animate({opacity:0},250),setTimeout(function(){screenBlockShare.css("display","none"),shareContainer.css("display","none")},250)}function addSongChangeMessage(t){console.log("ADD SONG CHANGE MESSAGE"),spotifyPlayer.getCurrentState().then(function(e){e?addMessage(t,"Now playing "+e.track_window.current_track.name,!0):console.error("No music playing.")})}function msToMinutesSeconds(e){var t=e/1e3,a=Math.floor(e/60),o=Math.floor(t-a);return a.toString()+":"+o.toString().padStart(2,"0")}function searchSpotify(e){$.ajax({url:"https://api.spotify.com/v1/search?type=album,artist,track,playlist&limit=8&q="+e,type:"GET",dataType:"json",headers:{Authorization:"Bearer "+accessToken},success:function(e){searchSpotifyResponse(e)},error:function(e){alert("An error occured while searching."),console.log(e)}})}function searchSpotifyResponse(e){console.log(e),addSongsResults(e.tracks),addArtistResults(e.artists),addAlbumsResults(e.albums),addPlaylistsResults(e.playlists),$(".search-item-image-container").hover(function(){$(".search-item-fan[data-id='"+$(this).data("id")+"']").stop(!0,!0),$(".search-item-fan[data-id='"+$(this).data("id")+"']").animate({width:"18em",paddingLeft:"4em",paddingRight:"1em"},150),$(".search-item-text-container[data-id='"+$(this).data("id")+"']").stop(!0,!0),$(".search-item-text-container[data-id='"+$(this).data("id")+"']").animate({marginLeft:"-4em",opacity:0},150)},function(){$(".search-item-fan[data-id='"+$(this).data("id")+"']").stop(!0,!0),$(".search-item-fan[data-id='"+$(this).data("id")+"']").animate({width:"0",paddingLeft:"0",paddingRight:"0"},150),$(".search-item-text-container[data-id='"+$(this).data("id")+"']").stop(!0,!0),$(".search-item-text-container[data-id='"+$(this).data("id")+"']").animate({marginLeft:"1.6vw",opacity:1},150)}),$(".search-item-play").click(function(){socket.emit("makeMeHost"),"song"==$(this).data("type")?spotifyPlay("spotify:track:"+$(this).data("id"),"spotify:album:"+$(this).data("extra"),null,!0):"playlist"==$(this).data("type")?spotifyPlayPlaylistAlbum("spotify:playlist:"+$(this).data("id"),!0):"artist"==$(this).data("type")?spotifyPlayArtist("spotify:artist:"+$(this).data("id")):"album"==$(this).data("type")&&spotifyPlayPlaylistAlbum("spotify:album:"+$(this).data("id"),!0),setTimeout(function(){changedSong(),updatePlayer(),addSongChangeMessage(user_id)},500),dummyAudio.play()}),$(".search-item-queue").click(function(){var e="spotify:track:"+$(this).data("id"),t=$(".search-item-name[data-id='"+$(this).data("id")+"']").html(),a=$(".search-item-artist[data-id='"+$(this).data("id")+"']").html(),o=$(".search-item-image[data-id='"+$(this).data("id")+"']").attr("src");addToSpotifyQueue(e,!0),socket.emit("addToQueue",{uri:e,name:t,artist:a,image:o}),addMessage(user_id,"Added "+t+" by "+a+" to the queue.",!0)}),$(".search-item-share").click(function(){fadeInShare($(this).data("href"),$(this).data("type"))}),$(".search-item-fan").css("width","0"),$(".search-item-fan").css("padding-left","0"),$(".search-item-fan").css("padding-right","0")}function spotifyPlay(e){var t,a,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=3<arguments.length&&void 0!==arguments[3]&&arguments[3];console.log("SPOTIFY PLAY:"),console.log("TRACK: "+e),console.log("CONTEXT: "+o),null!=o?("artist"==o.substring(8,14)&&(t=JSON.stringify({context_uri:o})),t=null!=n?JSON.stringify({context_uri:o,offset:{uri:e},position_ms:n}):JSON.stringify({context_uri:o,offset:{uri:e}}),$.ajax({url:"https://api.spotify.com/v1/me/player/play?device_id="+deviceId,data:t,type:"PUT",headers:{Authorization:"Bearer "+accessToken},success:function(){console.log("PLAY REQUEST SUCCESSFUL"),i&&makePopup("Playing song")},error:function(e){console.error("PLAY RESULT FAILED:"),console.error(e),i&&makePopup("Could not play song",!0)}})):(a=null!=n?JSON.stringify({uris:[e],position_ms:n}):JSON.stringify({uris:[e]}),$.ajax({url:"https://api.spotify.com/v1/me/player/play?device_id="+deviceId,data:a,type:"PUT",headers:{Authorization:"Bearer "+accessToken},success:function(){console.log("PLAY REQUEST SUCCESSFUL"),i&&makePopup("Playing song")},error:function(e){console.error("PLAY RESULT FAILED:"),console.error(e),i&&makePopup("Could not play song",!0)}}))}function spotifyPlayPlaylistAlbum(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];$.ajax({url:"https://api.spotify.com/v1/me/player/play?device_id="+deviceId,data:JSON.stringify({context_uri:e,offset:{position:0}}),type:"PUT",headers:{Authorization:"Bearer "+accessToken},success:function(){console.log("PLAY REQUEST SUCCESSFUL"),t&&makePopup("Playing successfully")},error:function(e){console.error("PLAY RESULT FAILED:"),console.error(e),makePopup("Couldn't play",!0)}})}function addToSpotifyQueue(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];console.log(e),console.log("addToSpotifyQueue"),console.log("https://api.spotify.com/v1/me/player/queue?uri="+e+"&device_id="+deviceId),console.log("Bearer "+accessToken),$.ajax({url:"https://api.spotify.com/v1/me/player/queue?uri="+e+"&device_id="+deviceId,type:"POST",headers:{Authorization:"Bearer "+accessToken},success:function(e){console.log("ADD TO QUEUE SUCCESSFUL"),console.log(e),t&&makePopup("Added to queue")},error:function(e){console.error("ADD TO QUEUE FAILED:"),console.error(e),t&&makePopup("Could not add to queue",!0)}})}function checkLiked(e){return new Promise(function(t,a){$.ajax({url:"https://api.spotify.com/v1/me/tracks/contains?ids="+e,type:"GET",headers:{Authorization:"Bearer "+accessToken},success:function(e){t(e[0])},error:function(e){console.error("CHECK LIKED FAILED"),console.error(e),makePopup("Error while getting saved tracks",!0),a()}})})}document.getElementById("messages-input").addEventListener("keyup",function(e){13===e.keyCode?(e.preventDefault(),socket.emit("message",message_input.value),message_input.value=""):socket.emit("typing")}),dummySearch.addEventListener("keyup",function(e){13===e.keyCode&&(e.preventDefault(),searchQuery=dummySearch.value,actualSearch.value=searchQuery,fadeInSearch(),setTimeout(function(){dummySearch.value=""},500),searchSpotify(searchQuery))}),actualSearch.addEventListener("keyup",function(e){13===e.keyCode&&(e.preventDefault(),searchSpotify(searchQuery=actualSearch.value))}),screenBlock.click(function(){fadeOutSearch()}),screenBlockShare.click(function(){fadeOutShare()});var paused=!1;function changedSong(){$("#player-control-pause").css("background-image","url('img/control-pause.svg')"),spotifyPlayer.getCurrentState().then(function(e){e?(console.log("CONTEXT: "+e.context.uri),console.log("URI: "+e.track_window.current_track.uri),currentTrack=e.track_window.current_track.uri,socket.emit("changeSong",{uri:e.track_window.current_track.uri,context:e.context.uri,name:e.track_window.current_track.name,paused:e.paused}),(e.paused?playbackPause:playbackResume)()):console.error("No music playing.")}),console.log("CHANGED SONG CALLED")}$("#player-control-pause").click(function(){(paused=!paused)?(playbackPause(),socket.emit("pause"),addMessage(user_id,"Paused playback",!0)):(playbackResume(),socket.emit("resume"),addMessage(user_id,"Resumed playback",!0))}),$("#player-control-back").click(function(){socket.emit("makeMeHost"),spotifyPlayer.previousTrack(),setTimeout(function(){changedSong(!0),updatePlayer(),addSongChangeMessage(user_id)},250)}),$("#player-control-forward").click(function(){socket.emit("makeMeHost"),spotifyPlayer.nextTrack(),setTimeout(function(){changedSong(!0),updatePlayer(),addSongChangeMessage(user_id)},250)});var playerImg=$("#player-image"),playerName=$("#player-name"),playerArtist=$("#player-artist");function updatePlayer(){spotifyPlayer.getCurrentState().then(function(e){e?(playerImg.attr("src",e.track_window.current_track.album.images[0].url),playerName.html(e.track_window.current_track.name),playerArtist.html(e.track_window.current_track.artists[0].name)):console.error("No music playing.")})}function playbackPause(){spotifyPlayer.pause(),dummyAudio.pause(),$("#player-control-pause").css("background-image","url('img/control-play.svg')"),paused=!0}function playbackResume(){spotifyPlayer.resume(),dummyAudio.play(),$("#player-control-pause").css("background-image","url('img/control-pause.svg')"),paused=!1}function updateLikedButton(){spotifyPlayer.getCurrentState().then(function(e){e?checkLiked(e.track_window.current_track.id).then(function(e){e?(console.log("LIKED"),likeBtn.css("background-image","url('img/share-like.svg')")):(console.log("UNLIKED"),likeBtn.css("background-image","url('img/share-unlike.svg')")),likeBtn.attr("data-liked",e)}):console.error("No music playing.")})}function likeUnlikeSong(e){like=likeBtn.attr("data-liked"),console.log("LIKEEEEE: "+like),req="true"==like?"DELETE":"PUT",$.ajax({url:"https://api.spotify.com/v1/me/tracks?ids="+e,type:req,headers:{Authorization:"Bearer "+accessToken},success:function(){updateLikedButton(),"true"==like?makePopup("Song removed from library"):makePopup("Song added to library")},error:function(){makePopup("Could not add song to library",!0)}})}function updateMediaSession(){"mediaSession"in navigator&&spotifyPlayer.getCurrentState().then(function(e){var t=[];e.track_window.current_track.album.images.forEach(function(e){t.push({src:e.url,sizes:e.width+"x"+e.height,type:"image/jpeg"})}),navigator.mediaSession.metadata=new MediaMetadata({title:e.track_window.current_track.name,artist:e.track_window.current_track.artists[0].name,album:e.track_window.current_track.album.name,artwork:t})})}likeBtn.click(function(){spotifyPlayer.getCurrentState().then(function(e){likeUnlikeSong(e.track_window.current_track.id)})}),shareBtn.click(function(){spotifyPlayer.getCurrentState().then(function(e){fadeInShare("https://open.spotify.com/track/"+e.track_window.current_track.id,"song")})}),"mediaSession"in navigator&&(console.log("ADDING MEDIA HADNLERS"),navigator.mediaSession.setActionHandler("pause",function(){playbackPause(),socket.emit("pause"),addMessage(user_id,"Paused playback",!0),dummyAudio.pause()}),navigator.mediaSession.setActionHandler("play",function(){playbackResume(),socket.emit("resume"),addMessage(user_id,"Resumed playback",!0),dummyAudio.play()}),navigator.mediaSession.setActionHandler("nexttrack",function(){socket.emit("makeMeHost"),spotifyPlayer.nextTrack(),setTimeout(function(){changedSong(!0),updatePlayer(),addSongChangeMessage(user_id)},250)}),navigator.mediaSession.setActionHandler("previoustrack",function(){socket.emit("makeMeHost"),spotifyPlayer.previousTrack(),setTimeout(function(){changedSong(!0),updatePlayer(),addSongChangeMessage(user_id)},250)}));